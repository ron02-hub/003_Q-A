# EV走行音アンケートアプリケーション 技術設計書

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                     クライアント（Browser）                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Streamlit Frontend                       │   │
│  │  - UI Components                                      │   │
│  │  - Audio/Video Player                                 │   │
│  │  - Progress Bar                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Streamlit Backend（Python）                 │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │ Session       │  │ Survey        │  │ Data          │   │
│  │ Manager       │  │ Controller    │  │ Manager       │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │ Media         │  │ Interview     │  │ Analysis      │   │
│  │ Handler       │  │ Engine        │  │ Engine        │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Data Storage Layer                       │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │ CSV/JSON      │  │ Session       │  │ Media         │   │
│  │ Files         │  │ State         │  │ Files         │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | バージョン | 用途 |
|----------|------|------------|------|
| Frontend | Streamlit | 1.30+ | WebUI構築 |
| Backend | Python | 3.8+ | ロジック実装 |
| データ保存 | CSV/JSON | - | 回答データ保存 |
| 分析 | pandas | 2.0+ | データ処理 |
| 可視化 | plotly | 5.0+ | グラフ描画 |
| 音声処理 | streamlit-audio | - | 音声再生 |

---

## 2. モジュール設計

### 2.1 ディレクトリ構造

```
003_アンケート設計/
├── app.py                      # メインアプリケーション
├── requirements.txt            # 依存パッケージ
├── config.py                   # 設定ファイル
├── components/                 # UIコンポーネント
│   ├── __init__.py
│   ├── media_player.py         # メディア再生
│   ├── survey_components.py    # アンケートUI部品
│   ├── progress_bar.py         # 進捗バー
│   └── chat_interface.py       # チャットUI
├── pages/                      # 各Stepのページ
│   ├── __init__.py
│   ├── phase1_introduction.py  # Step1: 導入
│   ├── phase2_evaluation.py    # Step2: 評価
│   ├── phase3_interview.py     # Step3: 詳細調査
│   └── phase5_summary.py       # Step4: まとめ
├── services/                   # ビジネスロジック
│   ├── __init__.py
│   ├── session_manager.py      # セッション管理
│   ├── survey_controller.py    # アンケート制御
│   ├── data_manager.py         # データ管理
│   └── interview_engine.py     # インタビューエンジン
├── utils/                      # ユーティリティ
│   ├── __init__.py
│   ├── constants.py            # 定数定義
│   └── helpers.py              # ヘルパー関数
├── data/                       # データ保存
│   ├── responses/              # 回答データ
│   └── exports/                # エクスポートデータ
├── 99_Material/                # 素材ファイル
│   ├── 00_Test/                # テスト用音声
│   └── 01_sample_Movie/        # 走行音サンプル
└── docs/                       # ドキュメント
```

### 2.2 モジュール詳細

#### 2.2.1 app.py（メインアプリケーション）

```python
# 主要機能
- ページルーティング
- セッション初期化
- 全体レイアウト管理
- フェーズ間遷移制御
```

#### 2.2.2 SessionManager（セッション管理）

```python
class SessionManager:
    """セッション状態を管理するクラス"""
    
    def __init__(self):
        self.session_id: str
        self.current_phase: int
        self.current_step: int
        self.responses: dict
        self.start_time: datetime
        self.group: str  # A or B (RCT用)
    
    def initialize_session(self) -> None:
        """新規セッションを初期化"""
        
    def save_response(self, key: str, value: Any) -> None:
        """回答を保存"""
        
    def get_progress(self) -> float:
        """進捗率を取得"""
        
    def assign_group(self) -> str:
        """ランダムにグループを割り当て"""
```

#### 2.2.3 SurveyController（アンケート制御）

```python
class SurveyController:
    """アンケートフローを制御するクラス"""
    
    def __init__(self, session_manager: SessionManager):
        self.session = session_manager
        self.phases = []
        
    def next_step(self) -> None:
        """次のステップへ進む"""
        
    def previous_step(self) -> None:
        """前のステップへ戻る"""
        
    def validate_response(self, response: dict) -> bool:
        """回答を検証"""
        
    def get_current_phase(self) -> Phase:
        """現在のフェーズを取得"""
```

#### 2.2.4 DataManager（データ管理）

```python
class DataManager:
    """データの保存・読み込みを管理するクラス"""
    
    def __init__(self, data_dir: str):
        self.data_dir = data_dir
        
    def save_responses(self, session_id: str, responses: dict) -> None:
        """回答データを保存（CSV/JSON）"""
        
    def load_responses(self, session_id: str) -> dict:
        """回答データを読み込み"""
        
    def export_to_excel(self, session_ids: list) -> str:
        """Excelファイルにエクスポート"""
        
    def get_statistics(self) -> dict:
        """統計データを取得"""
```

#### 2.2.5 InterviewEngine（インタビューエンジン）

```python
class InterviewEngine:
    """デプスインタビューの質問生成を管理"""
    
    def __init__(self):
        self.depth_level: int = 0
        self.topic: str = ""
        self.history: list = []
        
    def generate_question(self, previous_answer: str) -> str:
        """前の回答に基づいて次の質問を生成"""
        
    def extract_keywords(self, text: str) -> list:
        """テキストからキーワードを抽出"""
        
    def analyze_sentiment(self, text: str) -> str:
        """感情分析を実行"""
```

---

## 3. データモデル

### 3.1 セッションデータ

```json
{
  "session_id": "uuid-xxxx-xxxx",
  "created_at": "2026-01-09T10:00:00",
  "updated_at": "2026-01-09T10:45:00",
  "group": "A",
  "current_phase": 3,
  "current_step": 2,
  "completed": false
}
```

### 3.2 回答データスキーマ

```json
{
  "session_id": "uuid-xxxx-xxxx",
  "timestamp": "2026-01-09T10:30:00",
  
  "phase1": {
    "consent": true,
    "age_group": "30-39",
    "gender": "男性",
    "prefecture": "東京都",
    "driving_years": 10,
    "ev_experience": false,
    "sound_sensitivity": 3,
    "audio_check_passed": true
  },
  
  "phase2_sd": {
    "sample_order": ["ALTO", "Model3", "Fit"],
    "evaluations": [
      {
        "sample_id": "ALTO",
        "sd_scores": {
          "volume": 2,
          "texture": 1,
          "pleasantness": 3,
          "arousal": 0,
          "luxury": 1,
          "innovation": 2,
          "power": 1,
          "safety": 2,
          "naturalness": 1
        },
        "purchase_intent": 5,
        "wtp": 50000,
        "free_comment": "自然で心地よい音でした"
      }
    ]
  },
  
  "phase2_grid": {
    "best_sound": "ALTO",
    "worst_sound": "Ferrari",
    "best_reason_axis": "自然さ",
    "worst_reason_axis": "音量感",
    "laddering_up": [
      {"question": "なぜそれが良いと感じましたか？", "answer": "..."},
      {"question": "それが得られるとどんな気持ちになりますか？", "answer": "..."}
    ],
    "laddering_down": [
      {"question": "なぜそれが悪いと感じましたか？", "answer": "..."}
    ]
  },
  
  "phase3_interview": {
    "conversations": [
      {"role": "system", "content": "..."},
      {"role": "user", "content": "..."}
    ],
    "extracted_values": ["安心感", "自然さ", "高級感"]
  },
  
  "phase4_rct": {
    "group": "A",
    "presentation_order": [1, 2, 3],
    "comparison_result": {...}
  },
  
  "phase5_summary": {
    "overall_impression": "...",
    "additional_comments": "..."
  }
}
```

---

## 4. 画面設計

### 4.1 共通レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│  EV走行音アンケート                          進捗: ████░░ 60%│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                     [メインコンテンツ]                       │
│                                                             │
│                                                             │
│                                                             │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│         [< 戻る]                           [次へ >]         │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 フェーズ別画面構成

| フェーズ | 画面構成 | 主要コンポーネント |
|----------|----------|-------------------|
| Phase 1 | フォーム形式 | チェックボックス、ラジオボタン、スライダー |
| Phase 2-1 | メディア＋評価 | 音声プレイヤー、SD法スライダー |
| Phase 2-2 | 比較選択＋記述 | カード選択、テキスト入力 |
| Phase 3 | チャット形式 | チャットUI、選択肢ボタン |
| Phase 4 | 比較評価 | A/B比較UI |
| Phase 5 | フォーム形式 | テキストエリア |

---

## 5. API設計（内部関数）

### 5.1 セッション管理API

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `init_session()` | - | `str` | セッションIDを生成 |
| `save_progress()` | `phase`, `step`, `data` | `bool` | 進捗を保存 |
| `load_progress()` | `session_id` | `dict` | 進捗を読み込み |
| `get_group()` | `session_id` | `str` | 割り当てグループを取得 |

### 5.2 データ管理API

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `save_response()` | `session_id`, `phase`, `data` | `bool` | 回答を保存 |
| `export_csv()` | `session_ids` | `str` | CSVファイルパス |
| `export_excel()` | `session_ids` | `str` | Excelファイルパス |
| `get_all_responses()` | - | `DataFrame` | 全回答を取得 |

---

## 6. エラーハンドリング

### 6.1 エラー種別と対応

| エラー種別 | 原因 | 対応 |
|------------|------|------|
| 音声再生エラー | ファイル不正/未対応形式 | エラーメッセージ表示、再試行ボタン |
| セッションタイムアウト | 長時間の非アクティブ | 自動保存、復帰確認ダイアログ |
| データ保存エラー | ディスク容量/権限 | エラー通知、リトライ |
| 入力検証エラー | 不正な入力値 | 即時フィードバック |

### 6.2 ログ設計

```python
import logging

# ログレベル設定
LOG_LEVELS = {
    'DEBUG': 詳細なデバッグ情報,
    'INFO': 通常の動作情報,
    'WARNING': 警告（続行可能）,
    'ERROR': エラー（機能障害）,
    'CRITICAL': 重大エラー（システム停止）
}

# ログ出力先
- コンソール出力
- ファイル出力（data/logs/app.log）
```

---

## 7. セキュリティ設計

### 7.1 データ保護

| 項目 | 対策 |
|------|------|
| 個人情報 | 匿名化（UUIDによる管理） |
| データ保存 | ローカルファイルシステム |
| 通信 | HTTPS（デプロイ時） |

### 7.2 入力検証

- フォーム入力のサニタイズ
- ファイルパスのバリデーション
- SQLインジェクション対策（該当なし）

---

## 8. テスト設計

### 8.1 テスト種別

| テスト種別 | 対象 | ツール |
|------------|------|--------|
| ユニットテスト | 各モジュール | pytest |
| 統合テスト | フェーズ間連携 | pytest |
| E2Eテスト | 全体フロー | Selenium |
| 手動テスト | UI/UX確認 | チェックリスト |

### 8.2 テストケース例

```python
# ユニットテスト例
def test_session_manager_init():
    """セッション初期化のテスト"""
    sm = SessionManager()
    assert sm.session_id is not None
    assert sm.current_phase == 1
    
def test_random_group_assignment():
    """グループ割り当てのテスト"""
    sm = SessionManager()
    group = sm.assign_group()
    assert group in ['A', 'B']
```

---

## 9. デプロイメント

### 9.1 ローカル実行

```bash
# 仮想環境作成
python -m venv venv
venv\Scripts\activate  # Windows

# 依存パッケージインストール
pip install -r requirements.txt

# アプリケーション起動
streamlit run app.py
```

### 9.2 Streamlit Cloud（オプション）

```yaml
# .streamlit/config.toml
[server]
headless = true
port = 8501

[theme]
primaryColor = "#1E88E5"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F5F5F5"
textColor = "#212121"
```

---

## 10. パフォーマンス最適化

### 10.1 キャッシュ戦略

```python
@st.cache_data
def load_audio_files():
    """音声ファイルをキャッシュ"""
    pass

@st.cache_resource
def init_resources():
    """リソースをキャッシュ"""
    pass
```

### 10.2 遅延読み込み

- 音声ファイルは必要時にのみ読み込み
- 大きなデータセットは分割読み込み

---

## 更新履歴

| 日付 | バージョン | 更新内容 | 担当者 |
|------|-----------|----------|--------|
| 2026-01-09 | 1.0.0 | 初版作成 | AI Assistant |
| 2026-01-12 | 1.1.0 | Step表記変更、Phase4削除、ディレクトリ構造更新 | AI Assistant |