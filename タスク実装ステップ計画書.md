# EV走行音アンケートアプリケーション タスク実装ステップ計画書

## 1. プロジェクト概要

### 1.1 開発期間
- 開始日: 2026-01-09
- 目標完了日: 2026-01-15

### 1.2 開発フェーズ

| フェーズ | 期間 | 内容 | 状態 |
|----------|------|------|------|
| Phase A | Day 1 | 環境構築・基盤開発 | ✅ 完了 |
| Phase B | Day 2-3 | コアモジュール開発 | ✅ 完了 |
| Phase C | Day 3-4 | 各フェーズUI実装 | ✅ 完了 |
| Phase D | Day 5 | 統合・テスト | ✅ 完了 |
| Phase E | Day 6-7 | 改善・ドキュメント整備 | ✅ 完了 |
| Phase F | Day 8-9 | サンプルデータ生成・分析 | ✅ 完了 |

---

## 2. Phase A: 環境構築・基盤開発（Day 1）✅ 完了

### Task A-1: 開発環境セットアップ

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| A-1-1 | Python仮想環境作成 | venv作成完了 | ✅ |
| A-1-2 | 依存パッケージインストール | requirements.txt作成・インストール完了 | ✅ |
| A-1-3 | ディレクトリ構造作成 | 全フォルダ・ファイル作成完了 | ✅ |
| A-1-4 | Git初期化 | .gitignore設定、初回コミット完了 | ✅ |

**依存パッケージ（requirements.txt）:**
```
streamlit>=1.30.0
pandas>=2.0.0
numpy>=1.24.0
plotly>=5.18.0
openpyxl>=3.1.0
python-dotenv>=1.0.0
```

### Task A-2: 基本設定ファイル作成

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| A-2-1 | config.py作成 | パス設定、定数定義完了 | ✅ |
| A-2-2 | constants.py作成 | SD法軸、選択肢等の定数定義完了 | ✅ |
| A-2-3 | .streamlit/config.toml作成 | テーマ設定完了 | ✅ |

### Task A-3: メインアプリケーション雛形

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| A-3-1 | app.py基本構造作成 | ページルーティング動作確認 | ✅ |
| A-3-2 | セッション管理初期実装 | セッションID生成動作確認 | ✅ |
| A-3-3 | 共通レイアウト実装 | ヘッダー・プログレスバー表示確認 | ✅ |

---

## 3. Phase B: コアモジュール開発（Day 2-3）✅ 完了

### Task B-1: セッション管理モジュール

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| B-1-1 | SessionManagerクラス実装 | 基本機能動作確認 | ✅ |
| B-1-2 | セッション初期化機能 | UUID生成、初期状態設定完了 | ✅ |
| B-1-3 | 進捗管理機能 | フェーズ・ステップ遷移動作確認 | ✅ |
| B-1-4 | 回答保存機能 | st.session_stateへの保存確認 | ✅ |
| B-1-5 | グループ割り当て機能 | ランダム割り当て動作確認 | ✅ |

### Task B-2: データ管理モジュール

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| B-2-1 | DataManagerクラス実装 | 基本機能動作確認 | ✅ |
| B-2-2 | JSON保存機能 | 回答データのJSON出力確認 | ✅ |
| B-2-3 | CSV保存機能 | 回答データのCSV出力確認 | ✅ |
| B-2-4 | Excel出力機能 | レポート形式のExcel出力確認 | ✅ |

### Task B-3: メディアハンドラモジュール

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| B-3-1 | 音声ファイル読み込み機能 | WAV/MP3読み込み確認 | ✅ |
| B-3-2 | 音声再生コンポーネント | st.audio動作確認 | ✅ |
| B-3-3 | サンプル順序ランダム化 | ランダム順序生成確認 | ✅ |

### Task B-4: UIコンポーネント開発

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| B-4-1 | プログレスバーコンポーネント | 進捗表示動作確認 | ✅ |
| B-4-2 | SD法スライダーコンポーネント | 9軸スライダー動作確認 | ✅ |
| B-4-3 | リッカート尺度コンポーネント | 7段階選択動作確認 | ✅ |
| B-4-4 | チャットUIコンポーネント | メッセージ表示・入力動作確認 | ✅ |

---

## 4. Phase C: 各フェーズUI実装（Day 3-4）✅ 完了

### Task C-1: Phase 1実装（導入・属性収集）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-1-1 | 同意取得画面 | チェックボックス動作確認 | ✅ |
| C-1-2 | 基本属性入力画面 | 年齢・性別・地域入力確認 | ✅ |
| C-1-3 | 運転経験入力画面 | 運転歴・EV経験入力確認 | ✅ |
| C-1-4 | 音への感度入力画面 | スライダー動作確認 | ✅ |
| C-1-5 | 音声チェック画面 | テスト音声再生・確認動作確認 | ✅ |
| C-1-6 | データバリデーション | 必須項目チェック動作確認 | ✅ |

### Task C-2: Phase 2-1実装（SD法評価）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-2-1 | 音声サンプル提示画面 | 音声再生動作確認 | ✅ |
| C-2-2 | SD法評価入力画面 | 9軸スライダー入力確認 | ✅ |
| C-2-3 | 購買意欲評価画面 | 7段階リッカート入力確認 | ✅ |
| C-2-4 | WTP評価画面 | 価格選択入力確認 | ✅ |
| C-2-5 | 自由記述画面 | テキストエリア入力確認 | ✅ |
| C-2-6 | サンプルループ処理 | 複数サンプル順次評価確認 | ✅ |

### Task C-3: Phase 2-2実装（評価グリッド法）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-3-1 | 最良・最悪音選択画面 | サンプル選択動作確認 | ✅ |
| C-3-2 | 評価軸選択画面 | SD法軸選択動作確認 | ✅ |
| C-3-3 | ラダリング（上位概念）画面 | 選択式＋自由記述入力確認 | ✅ |
| C-3-4 | ラダリング（下位概念）画面 | 選択式＋自由記述入力確認 | ✅ |

### Task C-4: Phase 3実装（デプスインタビュー）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-4-1 | チャットUI実装 | メッセージ表示動作確認 | ✅ |
| C-4-2 | 質問シーケンス実装 | 順次質問表示確認 | ✅ |
| C-4-3 | 回答入力・保存機能 | テキスト入力・保存確認 | ✅ |
| C-4-4 | 動的質問生成（簡易版） | 前回答に基づく質問生成確認 | ✅ |

### Task C-5: Phase 4実装（ランダム化比較試験）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-5-1 | グループ表示機能 | 割り当てグループ表示確認 | ✅ |
| C-5-2 | 比較評価画面 | 順序別評価入力確認 | ✅ |

### Task C-6: Phase 5実装（まとめ・自由記述）

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| C-6-1 | 総合評価入力画面 | 自由記述入力確認 | ✅ |
| C-6-2 | 追加コメント入力画面 | 自由記述入力確認 | ✅ |
| C-6-3 | 完了画面 | 完了メッセージ表示確認 | ✅ |
| C-6-4 | データ保存処理 | 全回答データ保存確認 | ✅ |

---

## 5. Phase D: 統合・テスト（Day 5）✅ 完了

### Task D-1: 統合テスト

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| D-1-1 | フェーズ間遷移テスト | 全フェーズ順次遷移確認 | ✅ |
| D-1-2 | データ保存テスト | 全回答データ正常保存確認 | ✅ |
| D-1-3 | エラーハンドリングテスト | エラー時の動作確認 | ✅ |

### Task D-2: ユーザビリティテスト

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| D-2-1 | 所要時間測定 | 45分以内で完了確認 | ✅ |
| D-2-2 | UI/UXレビュー | 操作性・見やすさ確認 | ✅ |
| D-2-3 | 音声再生テスト | 全サンプル正常再生確認 | ✅ |

### Task D-3: バグ修正

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| D-3-1 | 発見バグの修正 | 全バグ修正完了 | ✅ |
| D-3-2 | 再テスト | 修正後の動作確認 | ✅ |

---

## 6. Phase E: 改善・ドキュメント整備（Day 6-7）✅ 完了

### Task E-1: 改善実装

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| E-1-1 | UI/UX改善 | レビュー結果に基づく改善完了 | ✅ |
| E-1-2 | パフォーマンス最適化 | スクロールトップ機能改善 | ✅ |
| E-1-3 | Phase4（RCT）削除 | 4ステップ構成に変更完了 | ✅ |
| E-1-4 | Step表記への変更 | Step1〜Step4表記に変更完了 | ✅ |
| E-1-5 | ラダリング選択肢拡張 | 20個＋その他に拡張完了 | ✅ |
| E-1-6 | 動画プレイヤー対応 | render_video_player実装完了 | ✅ |
| E-1-7 | ページナンバリング追加 | 全ページにナンバリング追加完了 | ✅ |

### Task E-2: ドキュメント整備

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| E-2-1 | README.md作成 | 使用方法記載完了 | ✅ |
| E-2-2 | コードコメント追加 | 主要関数にコメント追加完了 | ✅ |
| E-2-3 | mdファイル管理.md更新 | 全ドキュメント情報更新完了 | ✅ |

### Task E-3: 最終確認

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| E-3-1 | 全体通しテスト | 全機能正常動作確認 | ✅ |
| E-3-2 | デプロイ準備 | 本番環境設定完了 | ✅ |

---

## 7. Phase F: サンプルデータ生成・分析（Day 8-9）✅ 完了

### Task F-1: テスト計画策定

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| F-1-1 | テスト計画書作成 | サンプルデータ設計完了 | ✅ |
| F-1-2 | データ分析計画書作成 | 分析フレームワーク定義完了 | ✅ |

### Task F-2: サンプルデータ生成

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| F-2-1 | データ生成スクリプト作成 | generate_sample_data.py完成 | ✅ |
| F-2-2 | 100名分データ生成 | JSON/CSV出力完了 | ✅ |
| F-2-3 | データ検証 | 分布・整合性チェック完了 | ✅ |

### Task F-3: データ分析実施

| ステップ | 内容 | 完了条件 | 状態 |
|----------|------|----------|------|
| F-3-1 | 記述統計分析 | 基本統計量算出完了 | ✅ |
| F-3-2 | 比較・相関分析 | サンプル間比較完了 | ✅ |
| F-3-3 | セグメント分析 | クラスター分析完了 | ✅ |
| F-3-4 | 可視化・レポート | ダッシュボード作成完了 | ✅ |

---

## 8. チェックリスト

### 機能完了チェック

- [x] Step1: 導入・属性収集
- [x] Step2: SD法評価・トータル評価・ラダリング
- [x] Step3: 詳細調査（購買決定要因、印象、理想の走行音）
- [x] Step4: まとめ・自由記述
- [x] データ保存機能
- [x] Excel出力機能
- [x] 動画プレイヤー機能
- [x] ページナンバリング機能
- [x] ページトップボタン（A案）
- [ ] 自動スクロールトップ（B案）- 残課題

### サンプルデータ・分析チェック

- [x] テスト計画書作成
- [x] データ分析計画書作成
- [x] データ生成スクリプト作成
- [x] 100名分サンプルデータ生成
- [x] データ検証
- [x] 記述統計分析
- [x] 比較・相関分析
- [x] セグメント分析
- [x] 可視化・レポート生成

### 品質チェック

- [x] 全フェーズで45分以内に完了可能
- [x] 音声が正常に再生される
- [x] データが正しく保存される
- [x] エラーが適切にハンドリングされる
- [x] UIが見やすく使いやすい

---

---

## 9. リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 音声再生の互換性問題 | 高 | 中 | 複数ブラウザでのテスト |
| 所要時間超過 | 中 | 中 | 質問数の調整 |
| データ保存エラー | 高 | 低 | 自動保存・バックアップ実装 |
| セッション切れ | 中 | 中 | 状態復元機能実装 |

---

## 10. 残課題

### 未解決の技術課題

| 課題ID | 課題内容 | 優先度 | 状態 | 備考 |
|--------|----------|--------|------|------|
| ISSUE-001 | ページ遷移時の自動スクロールトップ（B案） | 低 | 未解決 | StreamlitのiFrame構造の制限により、JavaScriptでの自動スクロールが動作しない。A案（手動ページトップボタン）は実装済み |

### 詳細説明

#### ISSUE-001: 自動スクロールトップ機能

**問題の概要**:
- ページ遷移（「次へ」ボタンクリック）時に自動的にページトップにスクロールする機能が正常に動作しない

**試行した対策**:
1. `st.markdown`でJavaScriptを挿入 → コードがページに表示される問題発生
2. `components.html()`で`height=0`指定 → スクロールが実行されない
3. ページ変更検出＋遅延実行 → 効果なし

**原因分析**:
- StreamlitはiFrame内でレンダリングされるため、親ウィンドウへのスクロール操作が制限される
- `st.rerun()`後にJavaScriptが再実行されるタイミングの問題

**代替策（実装済み）**:
- A案: 各ページのナビゲーション部分に「ページトップ」ボタンを設置
- ユーザーが手動でクリックすることでスクロール可能

**今後の対応案**:
1. Streamlitの将来のバージョンで対応される可能性を待つ
2. URLフラグメント（`#top`）を活用した方法を検討
3. カスタムコンポーネントの開発を検討

---

## 更新履歴

| 日付 | バージョン | 更新内容 | 担当者 |
|------|-----------|----------|--------|
| 2026-01-09 | 1.0.0 | 初版作成 | AI Assistant |
| 2026-01-09 | 1.1.0 | Phase A〜C完了、進捗状況更新 | AI Assistant |
| 2026-01-09 | 1.2.0 | Phase D完了、動作確認テスト完了 | AI Assistant |
| 2026-01-12 | 2.0.0 | Phase E完了、UI改善実装（Step表記変更、Phase4削除、ラダリング選択肢拡張、動画対応、ページナンバリング追加） | AI Assistant |
| 2026-01-12 | 2.1.0 | 残課題セクション追加（自動スクロールトップ機能）、動画ファイル対応更新 | AI Assistant |
| 2026-01-12 | 3.0.0 | Phase F追加（サンプルデータ生成・分析）、テスト計画書・データ分析計画書作成 | AI Assistant |
| 2026-01-12 | 3.1.0 | Phase F完了（データ生成・分析スクリプト実装完了、100名分データ生成完了、可視化・レポート生成完了） | AI Assistant |